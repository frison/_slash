name: üöÄ To Dockerhub
on:
  push:
    tags:
      - 'v*'
    paths:
      - dev/**
      - services/**
      - Makefile
      - .github/workflows/dockerhub_frison.yml

jobs:
  dockerhub:
    name:  üê≥ Build and Publish Images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master

      # https://github.com/docker/login-action
      - name: Log into Dockerhub
        uses: docker/login-action@v2
        with:
          username:  ${{ secrets.DOCKER_USERNAME }}
          password:  ${{ secrets.DOCKER_TOKEN }}

      - name: Build Images
        run: |
          make composite-dockerfile

      - name: Publish Images
        run: |
          tnp() {
            docker buildx build . -f Dockerfile.composite \
              --platform linux/amd64,linux/arm64 \
              -t ${REPO}/$1:latest \
              -t ${REPO}/$1:${{ github.ref_name }} \
              --push
              --target $1
            docker tag $1:local ${REPO}/$1:latest
            docker tag $1:local ${REPO}/$1:${{ github.ref_name }}

            docker push ${REPO}/$1:latest
            docker push ${REPO}/$1:${{ github.ref_name }}
          }
          tnp dev-base
          tnp dev-python
          tnp dev-node
          tnp dev-rails
          tnp dev-utils
        env:
          REPO: frison

