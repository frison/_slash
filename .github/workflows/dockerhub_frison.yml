name: üöÄ To Dockerhub

# (Name of the workflow)-(fully formed ref (ie. refs/heads/main,refs/tags/v10,refs/pull/<pr_number>/merge))
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    tags:
      - 'v*'

jobs:
  dockerhub:
    name:  üê≥ Build and Publish Images
    runs-on: ubuntu-latest
    steps:
      -
        name: Checkout
        uses: actions/checkout@master

      # https://github.com/docker/login-action
      -
        name: Log into Dockerhub
        uses: docker/login-action@v2
        with:
          username:  ${{ secrets.DOCKER_USERNAME }}
          password:  ${{ secrets.DOCKER_TOKEN }}

      -
        name: Dump Context
        uses: ./.github/actions/dump-context
      # Add support for more platforms with QEMU (optional)
      # https://github.com/docker/setup-qemu-action
      # This is an architecture emulator that provides near-native speeds for multi-arch builds.
      #
      # The previous method used https://github.com/crazy-max/ghaction-docker-buildx
      # which is now split between the below two actions.
      -
        name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        platforms: arm64,amd64

      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        platforms: linux/amd64,linux/arm64

      -
        name: Build Compsite Dockerfile
        run: |
          make composite-dockerfile

      - name: Publish Images
        run: |
          tnp() {
            docker buildx build . -f Dockerfile.composite \
              --platform linux/amd64,linux/arm64 \
              -t ${REPO}/$1:latest \
              -t ${REPO}/$1:${{ github.ref_name }} \
              --push \
              --target $1
          }
          tnp dev-base
          tnp dev-python
          tnp dev-node
          tnp dev-rails
          tnp dev-utils
        env:
          REPO: frison

