name: üöÄ To Dockerhub
on:
  push:
    tags:
      - 'v*'
    paths:
      - dev/**
      - services/**
      - Makefile
      - .github/workflows/dockerhub_frison.yml

jobs:
  dockerhub:
    name:  üê≥ Build and Publish Images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master

      # https://github.com/docker/login-action
      - name: Log into Dockerhub
        uses: docker/login-action@v2
        with:
          username:  ${{ secrets.DOCKER_USERNAME }}
          password:  ${{ secrets.DOCKER_TOKEN }}

      - name: Build Compsite Dockerfile
        run: |
          make composite-dockerfile

     # Not using this action, encountered this
     # https://github.com/crazy-max/ghaction-docker-buildx/issues/213
     -  name: Set up Docker Buildx
        id: buildx
        uses: crazy-max/ghaction-docker-buildx@v3
        with:
          buildx-version: latest
          qemu-version: latest

      - name: Publish Images
        run: |
          tnp() {
            docker buildx build . -f Dockerfile.composite \
              --platform linux/amd64,linux/arm64 \
              -t ${REPO}/$1:latest \
              -t ${REPO}/$1:${{ github.ref_name }} \
              --push
              --target $1
          }
          tnp dev-base
          tnp dev-python
          tnp dev-node
          tnp dev-rails
          tnp dev-utils
        env:
          REPO: frison

